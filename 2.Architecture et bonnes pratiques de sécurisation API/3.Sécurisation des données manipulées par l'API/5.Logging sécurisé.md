# **7.5 — Logging sécurisé (ne jamais loguer un token complet)**

Le **logging** est indispensable pour comprendre ce qui se passe dans une API :

* surveiller les attaques,
* diagnostiquer des erreurs,
* analyser des incidents,
* vérifier le comportement des utilisateurs,
* suivre la performance.

**Mais un logging mal configuré peut devenir une énorme faille de sécurité.**

Ce chapitre explique :

* pourquoi les logs sont sensibles,
* ce qu’il ne faut jamais enregistrer,
* comment éviter la fuite de secrets,
* comment structurer un logging sécurisé,
* comment détecter des attaques sans compromettre la vie privée,
* et comment anonymiser ou tronquer les données critiques.

---

# **7.5.1 — Pourquoi les logs sont sensibles ?**

Parce qu’ils contiennent souvent :

* des données personnelles,
* des tokens d’accès,
* des sessions,
* des IDs internes,
* des payloads complets,
* des messages d'erreur détaillés,
* des traces d’exceptions.

En cas de fuite de logs, vous exposez :

* users,
* données privées,
* secrets techniques,
* architecture interne,
* tokens exploitables.

Les logs sont une **cible privilégiée** des attaquants.

---

# **7.5.2 — Erreur la plus dangereuse : loguer un token complet**

Exemple catastrophique :

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5c...
```

Si ce token apparaît dans :

* les logs API,
* les logs Nginx,
* les logs de debug,
* un dashboard de monitoring,

Alors n’importe qui ayant accès au log peut :

* se connecter comme l’utilisateur,
* accéder à ses données,
* escalader son compte,
* exécuter des actions.

Cette erreur est parmi les causes *n°1* de compromission API.

---

# **7.5.3 — Schéma : fuite d’un token via les logs**

```mermaid
flowchart LR
    A[API reçoit token] --> B[Token logué par erreur]
    B --> C[Log stocké dans un fichier/serveur]
    C --> D[Attaquant accède au log]
    D --> E[Rejeu de token<br>API compromise]
```

---

# **7.5.4 — Que faut-il loguer ? (et surtout NE PAS loguer)**

## ❌ NE JAMAIS loguer

* Token JWT complet
* Refresh token
* Password, même hashé
* Secret API
* Clé HMAC
* Données bancaires
* Données très sensibles (santé, adresses complètes…)
* Payloads entiers contenant des PII

## ✔ À loguer

* timestamp
* endpoint
* ID utilisateur (anonymisé)
* status code
* événements sécurité (succès/échec login, 403, brute force…)
* erreurs métiers (pas les stack traces complètes en prod)
* IP (parfois anonymisée selon RGPD)
* quelques meta-infos utiles

---

# **7.5.5 — Comment loguer un token de manière sécurisée ?**

Ne jamais loguer le token brut.
Uniquement une version tronquée.

Exemple :

```
Authorization: Bearer eyJhbGciOi...<redacted>
```

ou

```
token_hash = sha256(token)
```

Ainsi :

* on peut détecter un token réutilisé,
* sans jamais exposer le token réel.

---

# **7.5.6 — Tronquage sécurisé**

Tronquer en gardant seulement quelques caractères :

```
eyJhbGciOiJIUzI1...xyz789
```

ou

```
***REDACTED*** 
```

L’important :
→ assurer que **personne ne puisse reconstituer le token original**.

---

# **7.5.7 — Logging des erreurs**

Les erreurs **ne doivent jamais contenir** :

* des secrets,
* des chemins internes,
* des requêtes SQL brutes,
* des stack traces complètes (en prod),
* des données utilisateur non nécessaires.

### Exemple dangereux :

```
SQL Error: SELECT * FROM users WHERE email = 'alice@example.com' AND password = '123'
```

→ l’attaquant apprend trop de choses.

### Bonne pratique :

```
Database error on users table (masked)
```

---

# **7.5.8 — Protéger les logs eux-mêmes**

Les logs doivent être :

* stockés de manière sécurisée,
* accessibles uniquement aux admins / ops,
* chiffrés au repos,
* envoyés via TLS si transférés,
* purgés régulièrement (retention),
* surveillés (audit logs).

Les logs contiennent des informations sensibles →
ils doivent être traités comme **données critiques**.

---

# **7.5.9 — Détection d’attaques via logs**

Les logs permettent d’identifier :

### ✔ Tentatives de brute force

Plusieurs login échoués consécutifs.

### ✔ BOLA (API1)

Autorisations refusées répétées :

```
403 on /users/32
403 on /users/33
403 on /users/34
```

→ un attaquant explore les IDs.

### ✔ Rate limit trigger

Activité anormale.

### ✔ Accès depuis pays suspects

IP provenant de zones inattendues.

### ✔ Volume anormal de requêtes

Scraping massif possible.

Le logging doit être structuré pour permettre cette analyse.

---

# **7.5.10 — Schéma : pipeline de logging sécurisé**

```mermaid
flowchart TD
    A[Log brut] --> B[Filtrage (sanitize / redaction)]
    B --> C[Format structuré]
    C --> D[Stockage sécurisé]
    D --> E[Monitoring / Alerting]
```

---

# **7.5.11 — Erreurs classiques à éviter**

### ❌ Loguer tout le body des requêtes

Peut contenir PII, fichiers, tokens.

### ❌ Loguer les headers “Authorization” en clair

Très grave.

### ❌ Loguer en mode DEBUG en production

Expose le fonctionnement interne.

### ❌ Pas d’expiration des logs

Risque RGPD / fuite longue durée.

### ❌ Pas de droits d’accès restreints

Tout employé peut lire → fuite accidentelle.

---

# **7.5.12 — Bonnes pratiques essentielles**

* ✔ Redact (masquer) systématiquement les tokens
* ✔ Loguer en JSON structuré
* ✔ Avoir une politique de rétention (ex : 30 jours)
* ✔ Ne jamais loguer des secrets, même accidentellement
* ✔ Limiter le niveau de logs en production
* ✔ Mettre en place une surveillance (SIEM)
* ✔ Chiffrer les logs sensibles
* ✔ Vérifier régulièrement les logs pour détecter les attaques

---

# **7.5.13 — Résumé du sous-chapitre**

* Les logs sont essentiels mais extrêmement sensibles.
* Ne jamais loguer un token complet → risque majeur.
* Toujours tronquer ou hasher les informations critiques.
* Ne loguer que ce qui est utile → minimalisme.
* Protéger le stockage des logs (chiffrement, droits d’accès, rotation).
* Utiliser les logs pour détecter les attaques (BOLA, brute force, scraping).
* La sécurité des logs fait partie de la sécurité API globale.