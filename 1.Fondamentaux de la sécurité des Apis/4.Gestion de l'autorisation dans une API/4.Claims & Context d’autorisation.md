# **4.4 — Claims & Context d’autorisation**

Dans les API modernes — surtout celles utilisant des tokens porteurs (comme les JWT) — la décision d’autorisation repose en grande partie sur des **claims** et sur le **contexte** de la requête.

Ces deux éléments permettent à l’API d’appliquer efficacement les modèles RBAC, ABAC ou PBAC vus précédemment.

Ce sous-chapitre explique :

* ce que sont les *claims*,
* comment elles influencent l’autorisation,
* ce qu’est le *context*,
* comment l’API combine les deux pour décider d’accepter ou refuser une requête.

---

# **4.4.1 — Qu’est-ce qu’un “claim” ?**

Un **claim** est une information contenue dans un token (souvent un JWT).
Il décrit des éléments sur l’utilisateur ou sur la session.

Exemples de claims courants :

| Claim        | Signification           |
| ------------ | ----------------------- |
| `sub`        | Identifiant utilisateur |
| `email`      | Email de l’utilisateur  |
| `role`       | Rôle RBAC               |
| `scopes`     | Permissions précises    |
| `team`       | Équipe                  |
| `department` | Département             |
| `exp`        | Date d’expiration       |
| `iat`        | Date d'émission         |
| `iss`        | Émetteur du token       |

Les claims sont **signés** :
cela garantit qu’ils n’ont pas été modifiés.

---

# **4.4.2 — Pourquoi les claims sont essentiels ?**

Parce qu’eux seuls permettent à une API stateless de :

* comprendre *qui* appelle,
* déterminer *ce que l’utilisateur peut faire*,
* prendre une décision sans session côté serveur.

L’API lit les claims dans le token comme un passeport numérique.

---

# **4.4.3 — Types de claims**

### **1. Claims standards (normés)**

Dans le format JWT, certains claims sont définis par le standard :

* `sub` (subject)
* `iss` (issuer)
* `iat` (issued at)
* `exp` (expiration)
* `aud` (audience)

### **2. Claims personnalisés**

Ce sont ceux que l’application choisit d’ajouter :

* `role: "manager"`
* `team: "A"`
* `tenant: "client-42"`
* `permissions`: ["read:docs", "write:docs"]

Ils permettent d’appliquer RBAC, ABAC ou PBAC.

---

# **4.4.4 — Exemple de token avec claims**

```
{
  "sub": "12345",
  "role": "manager",
  "team": "A",
  "scopes": ["read:profil", "read:factures"],
  "exp": 1712345678
}
```

Ce token contient l'information nécessaire pour vérifier :

* l'identité,
* les permissions,
* le rôle,
* l’équipe,
* l’expiration.

---

# **4.4.5 — Qu’est-ce que le “context” d’autorisation ?**

Le **contexte** correspond à toutes les informations *externes au token* mais nécessaires pour prendre une décision.

Exemples :

### Attributs de la requête

* adresse IP
* User-Agent
* langue
* géolocalisation

### Attributs de la ressource

* propriétaire
* statut (public, interne, privé)
* appartenance à une équipe
* date de création
* classification

### Conditions système

* heure actuelle
* type de device
* niveau de risque
* environnement (prod / dev)

Le contexte enrichit l’autorisation.

---

# **4.4.6 — Fusion Claims + Contexte dans une décision d’accès**

L’API combine :

* ce que déclare le token (claims)
* ce que dit le système (contexte)

Pour appliquer une règle.

### Exemple

Endpoint :

```
GET /documents/7
```

Token :

```
role: "manager"
team: "A"
```

Ressource :

```
team: "A"
visibility: "interne"
```

Contexte :

```
ipCountry = "FR"
hour = 15
```

Politique PBAC :

```
allow if
    user.role == "manager"
    and user.team == ressource.team
    and ressource.visibility == "interne"
    and context.ipCountry == "FR"
    and context.hour between 8 and 18
```

→ Autorisé.

---

# **4.4.7 — Schéma : combinaison claims + contexte**

```mermaid
flowchart TD
    A[Requête API] --> B[Token<br>(Claims)]
    A --> C[Contexte<br>(IP, heure, device, etc.)]
    A --> D[Ressource<br>(attributs)]
    B --> E[Engine d'autorisation]
    C --> E
    D --> E
    E -->|Autorisé| F[OK]
    E -->|Refusé| G[403 Forbidden]
```

---

# **4.4.8 — Exemples de règles basées sur les claims**

### ✔ Basique (RBAC)

```
role == "admin"
```

### ✔ Avec scopes

```
"write:factures" in scopes
```

### ✔ Avec attribut utilisateur (ABAC)

```
user.team == resource.team
```

### ✔ Avec contexte (PBAC)

```
context.country == "FR" and context.hour < 20
```

---

# **4.4.9 — Mauvaises pratiques à éviter**

### ❌ Faire confiance uniquement aux claims

Si un token est volé → les claims sont valides mais mal utilisés.

### ❌ Mettre trop d’information dans les claims

Risque de fuite (JWT lisible en clair).

### ❌ Faire de l'autorisation uniquement dans le frontend

Extrêmement dangereux.

### ❌ Ne jamais utiliser le contexte

Privations de sécurité importantes (un admin depuis la Chine ?).

---

# **4.4.10 — Meilleures pratiques**

### ✔ Utiliser les claims uniquement pour des données nécessaires

Pas de données sensibles (adresse, numéro de carte, etc.).

### ✔ Toujours valider la signature du token

Sans ça, les claims ne valent rien.

### ✔ Ajouter le contexte pour renforcer la sécurité

GeoIP, device, heure, etc.

### ✔ Documenter clairement les politiques d’accès

Surtout si PBAC est utilisé.

---

# **4.4.11 — Résumé du sous-chapitre**

* Les claims sont des informations contenues dans les tokens (JWT).
* Le contexte est tout ce qui entoure la requête : IP, heure, ressource, device…
* L’autorisation API moderne combine les claims et le contexte.
* Cela permet d’appliquer RBAC, ABAC et PBAC.
* Les décisions sont basées sur des règles logiques et cohérentes.
* L’API doit vérifier systématiquement tous les claims et leur contexte.